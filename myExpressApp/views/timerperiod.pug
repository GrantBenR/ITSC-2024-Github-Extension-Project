extends default

block content
    #content
        div.recordHeader
            h1 TimerPeriodId: #{id}
            h1 TimerId: #{timerId}
            h3 Start Date: #{startDate}
            h3 End Date: #{endDate}
            h3 Total Time Elapsed #{TotalTimeElapsed}
        div.CanvasWrapper
            h1.CanvasHeader Periods from the Same Date and Their Sizes
            canvas#myChart
        h1 Related Records:
        p#idhidden #{timerId}
        p#Hidden #{JSON.stringify(timerperiods)}
        div#referenceList
        button(id="nextbtn" class="tabbtn" onclick="TabUp()") Next
        button(id="backbtn" class="tabbtn" onclick="TabDown()") Previous
    script(src="https://cdn.jsdelivr.net/npm/chart.js")
    script.
        var adjacentNames;
        var adjacentTimes;
        Main();
        async function Main()
        {
            await ListUserAndIssue();
            await ListTimerPeriods();
            await GetAdjacentPeriodsData();
            await GraphAdjacentPeriods();
        }
        async function ListTimerPeriods()
        {
            const timerperiodsReference = await document.getElementById("Hidden");
            const timerperiods = await JSON.parse(timerperiodsReference.textContent);
            const destinationDiv = document.getElementById("referenceList");
            for (let i = 0; i < timerperiods.length; i++)
            {
                var link = document.createElement('a');
                link.className = "referenceLink";
                link.href = "http://localhost:5220/views/timerperiodmodel/timerperiod/" + timerperiods[i].id;
                link.textContent = "Id: " + timerperiods[i].id + ", StartDate: " + timerperiods[i].startDate + ", EndDate: " + timerperiods[i].endDate + ", TimerId: " + timerperiods[i].timerId + "\n";
                destinationDiv.appendChild(link);
            }
        }
        async function ListUserAndIssue()
        {
            var idElement = await document.getElementById("idhidden");
            var id = Number(idElement.textContent);
            var timerResponse = await fetch("http://localhost:5220/timermodel/" + id + "/timer");
            var timer = await timerResponse.json();
            var userResponse = await fetch("http://localhost:5220/timermodel/" + id + "/user");
            var user = await userResponse.json();
            var issueResponse = await fetch("http://localhost:5220/timermodel/" + id + "/issue");
            var issue = await issueResponse.json();
            var destinationDiv = await document.getElementById("referenceList");
            var timerlink = await document.createElement('a');
            timerlink.className = "referenceLink";
            timerlink.href = "http://localhost:5220/views/timermodel/timer/" + id;
            timerlink.textContent = "Id: " + timer[0].id + ", userId: " + timer[0].userId + ", issueId: " + timer[0].issueId + "\n";
            destinationDiv.appendChild(timerlink);
            var userlink = await document.createElement('a');
            userlink.className = "referenceLink";
            userlink.href = "http://localhost:5220/views/usermodel/user/" + user[0].id;
            userlink.textContent = "Id: " + user[0].id + ", UserName: " + user[0].UserName + "\n";
            destinationDiv.appendChild(userlink);
            var issuelink = await document.createElement('a');
            issuelink.className = "referenceLink";
            issuelink.href = "http://localhost:5220/views/issuemodel/issue/" + issue[0].id;
            issuelink.textContent = "Id: " + issue[0].id + ", URL: " + issue[0].url + ", Name: " + issue[0].issueName + "\n";
            destinationDiv.appendChild(issuelink);
        }
        async function GetAdjacentPeriodsData()
        {
            var idElement = await document.getElementById("idhidden");
            var id = Number(idElement.textContent);
            var adjacentPeriodsResponse = await fetch("http://localhost:5220/timermodel/" + id + "/adjacenttimerperiods");
            var adjacentPeriods = await adjacentPeriodsResponse.json();
            adjacentTimes = await Promise.all(adjacentPeriods.map(async function(index){
                return index.totalTimeElapsed;
            }));
            adjacentNames = await Promise.all(adjacentPeriods.map(async function(index){
                var period = index.startDate + " - " + index.endDate;
                console.log(period);
                return period;
            }));
        }
        async function GraphAdjacentPeriods()
        {
            var myChart = document.getElementById("myChart");
            new Chart(myChart, {
                type: 'bar',
                data: {
                labels: adjacentNames,
                datasets: [{
                    label: 'Time spent on period',
                    data: adjacentTimes,
                    borderWidth: 1,
                    backgroundColor: '#9BD0F5'
                }]
                },
                options: {
                scales: {
                    y: {
                    beginAtZero: true
                    }
                }
                }
            });
        }
